#include "render.h"
#include "icons/icons.h"
#include "esp_lcd_panel_ops.h"
#include "esp_attr.h"
#include "esp_log.h"
#include <string.h>

// Font and text helpers
#define FONT_FIRST_CHAR 32
#define FONT_LAST_CHAR 126
#define FONT_WIDTH 5
#define FONT_HEIGHT 7
#define FONT_SCALE 2

static const uint8_t font5x7[95][5] = {
    {0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x5f, 0x00, 0x00},
    {0x00, 0x07, 0x00, 0x07, 0x00}, {0x14, 0x7f, 0x14, 0x7f, 0x14},
    {0x24, 0x2a, 0x7f, 0x2a, 0x12}, {0x23, 0x13, 0x08, 0x64, 0x62},
    {0x36, 0x49, 0x55, 0x22, 0x50}, {0x00, 0x05, 0x03, 0x00, 0x00},
    {0x00, 0x1c, 0x22, 0x41, 0x00}, {0x00, 0x41, 0x22, 0x1c, 0x00},
    {0x14, 0x08, 0x3e, 0x08, 0x14}, {0x08, 0x08, 0x3e, 0x08, 0x08},
    {0x00, 0x50, 0x30, 0x00, 0x00}, {0x08, 0x08, 0x08, 0x08, 0x08},
    {0x00, 0x60, 0x60, 0x00, 0x00}, {0x20, 0x10, 0x08, 0x04, 0x02},
    {0x3e, 0x51, 0x49, 0x45, 0x3e}, {0x00, 0x42, 0x7f, 0x40, 0x00},
    {0x42, 0x61, 0x51, 0x49, 0x46}, {0x21, 0x41, 0x45, 0x4b, 0x31},
    {0x18, 0x14, 0x12, 0x7f, 0x10}, {0x27, 0x45, 0x45, 0x45, 0x39},
    {0x3c, 0x4a, 0x49, 0x49, 0x30}, {0x01, 0x71, 0x09, 0x05, 0x03},
    {0x36, 0x49, 0x49, 0x49, 0x36}, {0x06, 0x49, 0x49, 0x29, 0x1e},
    {0x00, 0x36, 0x36, 0x00, 0x00}, {0x00, 0x56, 0x36, 0x00, 0x00},
    {0x08, 0x14, 0x22, 0x41, 0x00}, {0x14, 0x14, 0x14, 0x14, 0x14},
    {0x00, 0x41, 0x22, 0x14, 0x08}, {0x02, 0x01, 0x51, 0x09, 0x06},
    {0x32, 0x49, 0x79, 0x41, 0x3e}, {0x7e, 0x11, 0x11, 0x11, 0x7e},
    {0x7f, 0x49, 0x49, 0x49, 0x36}, {0x3e, 0x41, 0x41, 0x41, 0x22},
    {0x7f, 0x41, 0x41, 0x22, 0x1c}, {0x7f, 0x49, 0x49, 0x49, 0x41},
    {0x7f, 0x09, 0x09, 0x09, 0x01}, {0x3e, 0x41, 0x41, 0x51, 0x73},
    {0x7f, 0x08, 0x08, 0x08, 0x7f}, {0x00, 0x41, 0x7f, 0x41, 0x00},
    {0x20, 0x40, 0x41, 0x3f, 0x01}, {0x7f, 0x08, 0x14, 0x22, 0x41},
    {0x7f, 0x40, 0x40, 0x40, 0x40}, {0x7f, 0x02, 0x0c, 0x02, 0x7f},
    {0x7f, 0x04, 0x08, 0x10, 0x7f}, {0x3e, 0x41, 0x41, 0x41, 0x3e},
    {0x7f, 0x09, 0x09, 0x09, 0x06}, {0x3e, 0x41, 0x51, 0x21, 0x5e},
    {0x7f, 0x09, 0x19, 0x29, 0x46}, {0x46, 0x49, 0x49, 0x49, 0x31},
    {0x01, 0x01, 0x7f, 0x01, 0x01}, {0x3f, 0x40, 0x40, 0x40, 0x3f},
    {0x1f, 0x20, 0x40, 0x20, 0x1f}, {0x7f, 0x20, 0x18, 0x20, 0x7f},
    {0x63, 0x14, 0x08, 0x14, 0x63}, {0x07, 0x08, 0x70, 0x08, 0x07},
    {0x61, 0x51, 0x49, 0x45, 0x43}, {0x00, 0x7f, 0x41, 0x41, 0x00},
    {0x02, 0x04, 0x08, 0x10, 0x20}, {0x00, 0x41, 0x41, 0x7f, 0x00},
    {0x04, 0x02, 0x01, 0x02, 0x04}, {0x40, 0x40, 0x40, 0x40, 0x40},
    {0x00, 0x01, 0x02, 0x04, 0x00}, {0x20, 0x54, 0x54, 0x54, 0x78},
    {0x7f, 0x48, 0x44, 0x44, 0x38}, {0x38, 0x44, 0x44, 0x44, 0x20},
    {0x38, 0x44, 0x44, 0x48, 0x7f}, {0x38, 0x54, 0x54, 0x54, 0x18},
    {0x08, 0x7e, 0x09, 0x01, 0x02}, {0x0c, 0x52, 0x52, 0x52, 0x3e},
    {0x7f, 0x08, 0x04, 0x04, 0x78}, {0x00, 0x44, 0x7d, 0x40, 0x00},
    {0x20, 0x40, 0x44, 0x3d, 0x00}, {0x7f, 0x10, 0x28, 0x44, 0x00},
    {0x00, 0x41, 0x7f, 0x40, 0x00}, {0x7c, 0x04, 0x18, 0x04, 0x78},
    {0x7c, 0x08, 0x04, 0x04, 0x78}, {0x38, 0x44, 0x44, 0x44, 0x38},
    {0x7c, 0x14, 0x14, 0x14, 0x08}, {0x08, 0x14, 0x14, 0x18, 0x7c},
    {0x7c, 0x08, 0x04, 0x04, 0x08}, {0x48, 0x54, 0x54, 0x54, 0x20},
    {0x04, 0x3f, 0x44, 0x40, 0x20}, {0x3c, 0x40, 0x40, 0x20, 0x7c},
    {0x1c, 0x20, 0x40, 0x20, 0x1c}, {0x3c, 0x40, 0x30, 0x40, 0x3c},
    {0x44, 0x28, 0x10, 0x28, 0x44}, {0x0c, 0x50, 0x50, 0x50, 0x3c},
    {0x44, 0x64, 0x54, 0x4c, 0x44}, {0x00, 0x08, 0x36, 0x41, 0x00},
    {0x00, 0x00, 0x7f, 0x00, 0x00}, {0x00, 0x41, 0x36, 0x08, 0x00},
    {0x08, 0x04, 0x08, 0x10, 0x08},
};

static DMA_ATTR uint16_t s_chunk_buf[2][LCD_DMA_CHUNK_BYTES / sizeof(uint16_t)] __attribute__((aligned(LCD_DMA_ALIGN)));

static int calc_chunk_rows(int width_pixels) {
    size_t row_bytes = (size_t)width_pixels * sizeof(uint16_t);
    int rows = LCD_DMA_CHUNK_BYTES / row_bytes;
    if (rows < 1) rows = 1;
    while ((row_bytes * rows) % LCD_DMA_ALIGN != 0 && rows > 1) {
        rows--;
    }
    return rows;
}

bool render_panel_draw_bitmap_chunked(esp_lcd_panel_handle_t panel, const uint16_t *buf, int buf_width, int buf_height) {
    if (!panel || !buf) return false;
    int buf_select = 0;
    int draw_w = buf_width > LCD_H_RES ? LCD_H_RES : buf_width;
    int draw_h = buf_height > LCD_V_RES ? LCD_V_RES : buf_height;
    int rows_per_chunk = calc_chunk_rows(draw_w);
    if (rows_per_chunk < 1) rows_per_chunk = 1;
    int max_rows_in_buf = (int)(sizeof(s_chunk_buf) / sizeof(s_chunk_buf[0]) / draw_w);
    if (max_rows_in_buf < 1) max_rows_in_buf = 1;
    if (rows_per_chunk > max_rows_in_buf) rows_per_chunk = max_rows_in_buf;

    esp_err_t err = ESP_OK;
    for (int y = 0; y < draw_h && err == ESP_OK; y += rows_per_chunk) {
        int h = rows_per_chunk;
        if (y + h > draw_h) h = draw_h - y;
        const uint16_t *row = buf + (y * buf_width);
        for (int r = 0; r < h; r++) {
            memcpy(&s_chunk_buf[buf_select][r * draw_w], row + r * buf_width, draw_w * sizeof(uint16_t));
        }
        err = esp_lcd_panel_draw_bitmap(panel, 0, y, draw_w, y + h, s_chunk_buf[buf_select]);
        buf_select ^= 1;
    }
    if (err != ESP_OK) {
        ESP_LOGE("RENDER", "Draw bitmap failed: %s", esp_err_to_name(err));
    }
    return err == ESP_OK;
}

void render_framebuf_fill_color(uint16_t *frame_buf, uint16_t color) {
    if (!frame_buf) return;
    size_t pixel_count = (size_t)LCD_H_RES * (size_t)LCD_V_RES;
    for (size_t i = 0; i < pixel_count; i++) {
        frame_buf[i] = color;
    }
}

void render_fill_color(esp_lcd_panel_handle_t panel, uint16_t *frame_buf, uint16_t color) {
    render_framebuf_fill_color(frame_buf, color);
    render_panel_draw_bitmap_chunked(panel, frame_buf, LCD_H_RES, LCD_V_RES);
}

void render_fill_rect(uint16_t *frame_buf, int x, int y, int w, int h, uint16_t color) {
    if (!frame_buf) return;
    if (x < 0 || y < 0 || x + w > LCD_H_RES || y + h > LCD_V_RES) return;
    for (int yy = y; yy < y + h; yy++) {
        uint16_t *row = frame_buf + (yy * LCD_H_RES) + x;
        for (int xx = 0; xx < w; xx++) {
            row[xx] = color;
        }
    }
}

void render_draw_rect_outline(uint16_t *frame_buf, int x, int y, int w, int h, uint16_t color) {
    if (!frame_buf) return;
    if (x < 0 || y < 0 || x + w > LCD_H_RES || y + h > LCD_V_RES) return;
    render_fill_rect(frame_buf, x, y, w, 1, color);
    render_fill_rect(frame_buf, x, y + h - 1, w, 1, color);
    render_fill_rect(frame_buf, x, y, 1, h, color);
    render_fill_rect(frame_buf, x + w - 1, y, 1, h, color);
}

static void render_draw_char(uint16_t *frame_buf, int x, int y, char c, uint16_t color) {
    if (c < FONT_FIRST_CHAR || c > FONT_LAST_CHAR || !frame_buf) return;
    const uint8_t *glyph = font5x7[c - FONT_FIRST_CHAR];
    for (int col = 0; col < FONT_WIDTH; col++) {
        uint8_t line = glyph[col];
        for (int row = 0; row < FONT_HEIGHT; row++) {
            if (line & 0x01) {
                int px = x + col * FONT_SCALE;
                int py = y + row * FONT_SCALE;
                for (int dy = 0; dy < FONT_SCALE; dy++) {
                    for (int dx = 0; dx < FONT_SCALE; dx++) {
                        int fx = px + dx;
                        int fy = py + dy;
                        if (fx >= 0 && fy >= 0 && fx < LCD_H_RES && fy < LCD_V_RES) {
                            frame_buf[fy * LCD_H_RES + fx] = color;
                        }
                    }
                }
            }
            line >>= 1;
        }
    }
}

static int render_text_width_px(const char *text) {
    if (!text) return 0;
    size_t len = strnlen(text, 64);
    return (int)len * (FONT_WIDTH + 1) * FONT_SCALE;
}

void render_draw_text(uint16_t *frame_buf, int x, int y, const char *text, uint16_t color) {
    if (!frame_buf || !text) return;
    int cursor_x = x;
    while (*text) {
        render_draw_char(frame_buf, cursor_x, y, *text, color);
        cursor_x += (FONT_WIDTH + 1) * FONT_SCALE;
        text++;
    }
}

void render_status_screen(esp_lcd_panel_handle_t panel, uint16_t *frame_buf, const char *line1, const char *line2, uint16_t bg_color, uint16_t fg_color, bool wifi_connected) {
    if (!frame_buf || !panel) return;
    render_framebuf_fill_color(frame_buf, bg_color);
    int y = (LCD_V_RES / 2) - (FONT_HEIGHT * FONT_SCALE);
    if (line1) {
        int x = (LCD_H_RES - render_text_width_px(line1)) / 2;
        if (x < 0) x = 0;
        render_draw_text(frame_buf, x, y, line1, fg_color);
    }
    if (line2) {
        int x = (LCD_H_RES - render_text_width_px(line2)) / 2;
        if (x < 0) x = 0;
        render_draw_text(frame_buf, x, y + FONT_HEIGHT * FONT_SCALE + 10, line2, fg_color);
    }
    icons_draw_status_badges(frame_buf, wifi_connected);
    render_panel_draw_bitmap_chunked(panel, frame_buf, LCD_H_RES, LCD_V_RES);
}
